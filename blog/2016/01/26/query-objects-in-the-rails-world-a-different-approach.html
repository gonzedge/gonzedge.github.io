<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <title> Query Objects in the Rails world - A Different Approach - gonzedge.com </title> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml"/> <link href="/stylesheets/all-3b0cf2bc.css" rel=stylesheet /> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72477714-1', 'auto');
  ga('send', 'pageview');

</script> </head> <body> <nav class="navbar navbar-default" role=nav> <div class=container> <div class=row> <div class="col-sm-3 col-xs-6"> <header class=navbar-header> <h1 class=navbar-title> <a href="/" class=navbar-brand> <code>@gonzedge</code> </a> </h1> </header> </div> <div class="col-sm-7 hidden-xs"> <p class="navbar-text hidden-xs hidden-sm"> <code>Adventures of a software development generalist</code> </p> </div> <div class="col-sm-2 col-xs-6"> <div class=navbar-right> <ul class="nav navbar-nav"> <li> <a href="https://github.com/gonzedge" class=social-link> <i class="fa fa-github"></i> </a> </li> </ul> </div> </div> </div> </div> </nav> <div class=container> <div class=row> <aside class="col-sm-3 hidden-xs"> <div class=sidebar-module> <h4> Featured <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2012/04/27/git-removing-sensitive-data-and-rewriting-history.html">Git: Removing sensitive data and rewriting history</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/11/installing-macvim-with-lua-enabled-through-homebrew.html">Installing MacVim with Lua enabled through Homebrew</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4> Recent <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020/07/26/using-certbot-to-add-lets-encrypt-certificate-on-heroku.html">Using certbot to add Let's Encrypt certificate on Heroku</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2017/01/23/rambling-trie-1-0-0-released.html">Rambling Trie 1.0.0 released!</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4>Tags</h4> <ol class="list-inline tags"> <li> <h5> <a href="/blog/tags/ruby.html">ruby (35)</a> </h5> </li> <li> <h5> <a href="/blog/tags/instructions.html">instructions (34)</a> </h5> </li> <li> <h5> <a href="/blog/tags/plugins-and-libraries.html">plugins and libraries (24)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rails.html">rails (24)</a> </h5> </li> <li> <h5> <a href="/blog/tags/releases.html">releases (18)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-slider.html">rambling-slider (17)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jquery.html">jquery (16)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rails-3-1.html">rails 3.1 (16)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rubygems.html">rubygems (15)</a> </h5> </li> <li> <h5> <a href="/blog/tags/slider.html">slider (14)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nivo-slider.html">nivo slider (14)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling.html">rambling (12)</a> </h5> </li> <li> <h5> <a href="/blog/tags/fixes.html">fixes (11)</a> </h5> </li> <li> <h5> <a href="/blog/tags/new-site.html">new site (8)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-trie.html">rambling-trie (8)</a> </h5> </li> <li> <h5> <a href="/blog/tags/performance.html">performance (7)</a> </h5> </li> <li> <h5> <a href="/blog/tags/data-structure.html">data structure (7)</a> </h5> </li> <li> <h5> <a href="/blog/tags/testing.html">testing (6)</a> </h5> </li> <li> <h5> <a href="/blog/tags/vim.html">vim (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/bugs.html">bugs (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/opinions.html">opinions (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/javascript.html">javascript (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/refactoring.html">refactoring (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/git.html">git (4)</a> </h5> </li> <li> <h5> <a href="/blog/tags/coffeescript.html">coffeescript (4)</a> </h5> </li> <li> <h5> <a href="/blog/tags/flash.html">flash (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/heroku.html">heroku (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-slider-rails.html">rambling-slider-rails (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/capybara.html">capybara (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rvm.html">rvm (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/design-patterns.html">design-patterns (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/new-look.html">new look (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rubymine.html">rubymine (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/markdown.html">markdown (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/error-handling.html">error handling (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/database-migrations.html">database migrations (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/ssh.html">ssh (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/ubuntu.html">ubuntu (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/cyanogenmod.html">cyanogenmod (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nodejs.html">nodejs (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/haml.html">haml (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jasmine.html">jasmine (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/android.html">android (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/selenium.html">selenium (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nokogiri.html">nokogiri (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/refinerycms.html">refinerycms (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/internet-explorer.html">internet explorer (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/mercurial.html">mercurial (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jetbrains.html">jetbrains (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/windows.html">windows (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/actionmailer.html">actionmailer (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/postgresql.html">postgresql (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/i18n.html">i18n (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/capybara-webkit.html">capybara-webkit (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/will-paginate.html">will_paginate (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/deployment.html">deployment (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/activerecord.html">activerecord (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/background-tasks.html">background tasks (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/cron.html">cron (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/simple-navigation.html">simple-navigation (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/html.html">html (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/erb.html">erb (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/assets.html">assets (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/bash.html">bash (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/github.html">github (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/pygments.html">pygments (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/lua.html">lua (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/homebrew.html">homebrew (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/powershell.html">powershell (1)</a> </h5> </li> </ol> </div> </aside> <div id=main class=col-sm-9 role=main> <h1> Query Objects in the Rails world - A Different Approach </h1> <p> <small>January 26, 2016</small> </p> <p>If you have worked with <a href="http://rubyonrails.org">Ruby on Rails</a> before then you might be familiar with ActiveRecord <code>scopes</code>. Using them, you can achieve what many would consider very readable code. Let&rsquo;s say that we have an application where we display an inbox where users receive messages.</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre></div> <p>Now, let&rsquo;s imagine that after reading a <code>Message</code>, it is marked as read, and let&rsquo;s represent that with a <code>read</code> column in the database. Additionally, our users can either archive the <code>Message</code> or move it to the trash. We&rsquo;ll represent this concept with a <code>location</code> column in the <code>messages</code> table.</p> <h2>Querying the database the Rails way</h2> <p>Let&rsquo;s say that our users want to have a way to view unread messages in their inbox. Using <code>ActiveRecord</code>, you could achieve this with:</p> <div class=highlight><pre class="highlight ruby"><code><span class="no">Message</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">,</span> <span class="ss">read: </span><span class="kp">false</span><span class="p">)</span>
</code></pre></div> <p>If you were to define scopes, you can make that a bit more readable and reusable:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span><span class="p">(</span><span class="ss">:inbox</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span><span class="p">(</span><span class="ss">:read</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">read: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># ...</span>

<span class="no">Message</span><span class="p">.</span><span class="nf">inbox</span><span class="p">.</span><span class="nf">unread</span>
</code></pre></div> <p>Scopes also make it easier to test each individual query against the database (you probably don&rsquo;t want to mock the database in this context).</p> <p>However, there are a few issues with this approach. If you have enough chained scopes, you can get pretty verbose with these, and the <code>Message</code> class quickly becomes the junkyard for all the database related operations. Plus, what if you have several places in the application where you want to load these messages? How do you test that you are loading the correct data from the database in these chained scopes? Do you have a separate scope that combines them both? What if you have multiple combinations?</p> <p>Enter&hellip;</p> <h2>The Query Object pattern</h2> <p>A <a href="http://martinfowler.com/eaaCatalog/queryObject.html">Query Object</a> represents a database query and it fits perfectly into our requirements. It can be reused across different places in the application while at the same time hiding the querying logic. It also provides a good isolated unit to test.</p> <p>Back when I was doing .NET, I used and embraced this concept as much as possible but for some reason when I started using Rails a few years ago, it kind of fell off my toolbelt.</p> <h3>An initial implementation in Ruby</h3> <p>A good initial implementation comes from <a href="http://codeclimate.com">CodeClimate</a>&rsquo;s <a href="http://blog.codeclimate.com/blog/2012/10/17/7-ways-to-decompose-fat-activerecord-models/">7 Ways to Decompose Fat ActiveRecord Models</a>. Following their lead, you could come up with something like this:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">relation</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="vi">@relation</span> <span class="o">=</span> <span class="n">relation</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">find_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@relation</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">read: </span><span class="kp">false</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">find_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Here, we initialize the query object with a default <code>ActiveRecord::Relation</code> represented by the <code>Message.all</code> <code>scope</code>. Then, whenever you want to access the unread inbox <code>Message</code>s, you just create a new instance of this object and iterate:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">unread_inbox_messages</span> <span class="o">=</span> <span class="no">UnreadInboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span>
<span class="n">unread_inbox_messages</span><span class="p">.</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">message</span><span class="p">.</span><span class="nf">body</span>
<span class="k">end</span>

</code></pre></div> <p>When I started using this approach heavily, I found myself wanting to use more than just <code>#find_each</code> and started delegating all the usual methods down to the resulting <code>ActiveRecord::Relation</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">relation</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="vi">@relation</span> <span class="o">=</span> <span class="n">relation</span>
  <span class="k">end</span>

  <span class="n">delegate</span> <span class="ss">:find_each</span><span class="p">,</span> <span class="ss">:each</span><span class="p">,</span> <span class="ss">:count</span><span class="p">,</span> <span class="c1">#... etc</span>
    <span class="ss">to: :results</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">results</span>
    <span class="vi">@relation</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">read: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Then, I ran into another issue: what if I want to parameterize one of the query&rsquo;s arguments? I wanted to be able to do something like this:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">unread_inbox_messages_from_other_user</span> <span class="o">=</span> <span class="no">UnreadInboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">from: </span><span class="n">other_user</span><span class="p">)</span>
</code></pre></div> <p>I could pass that as an additional param to the initialize, but then how do I initialize the default relation? I could try and pass that down to <code>results</code>, but then I cannot delegate methods down to results anymore. How could I make these query objects chainable so that I can reuse some of the logic a-la-Rails-scopes?</p> <h3>A Different Approach</h3> <p>After some thought, I came to the conclusion that passing the <code>ActiveRecord::Relation</code> down to the <code>#results</code> method instead of doing it in initialization would better fit my requirements, so I ended up with this (note that now I&rsquo;m calling it <code>scope</code> instead of <code>relation</code>):</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="n">scope</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">read: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>And you can use it like this:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">unread_inbox_messages</span> <span class="o">=</span> <span class="no">UnreadInboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">results</span>
</code></pre></div> <p>This makes it so that the outcome of the <code>UnreadInboxMessagesQuery</code> is a plain old <code>ActiveRecord::Relation</code> which makes it easy to access <code>find_each</code>, <code>each</code>, <code>count</code>, etc.</p> <p>Then, if we want to achieve this:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">unread_inbox_messages_from_other_user</span> <span class="o">=</span> <span class="no">UnreadInboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">from: </span><span class="n">other_user</span><span class="p">).</span><span class="nf">results</span>
</code></pre></div> <p>We can change the query object to:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">from: </span><span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@from</span> <span class="o">=</span> <span class="n">from</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="n">messages_from_user</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">location: </span><span class="s1">'inbox'</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">read: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="nb">attr_reader</span> <span class="ss">:from</span>

  <span class="k">def</span> <span class="nf">messages_from_user</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">from</span> <span class="p">?</span> <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">from: </span><span class="n">from</span><span class="p">)</span> <span class="p">:</span> <span class="n">scope</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <h3>Chainable Query Objects!</h3> <p>A nice consequence of this approach is that you can chain these query objects to achieve what <code>ActiveRecord</code> <code>scopes</code> give you. If you want to get all the unread inbox messages, then you can:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">unread_messages</span> <span class="o">=</span> <span class="no">UnreadMessagesQuery</span><span class="p">.</span><span class="nf">new</span>
<span class="n">inbox_messages</span> <span class="o">=</span> <span class="no">InboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span>
<span class="n">unread_inbox_messages</span> <span class="o">=</span> <span class="n">unread_messages</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">inbox_messages</span><span class="p">.</span><span class="nf">results</span><span class="p">)</span>
</code></pre></div> <p>With this in mind, let&rsquo;s see a new implementation of <code>UnreadInboxMessagesQuery</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="c1"># initialize...</span>

  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="n">unread_messages</span> <span class="o">=</span> <span class="no">UnreadMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
    <span class="n">inbox_messages</span> <span class="o">=</span> <span class="no">InboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
    <span class="n">messages_from_user</span> <span class="o">=</span> <span class="no">MessagesFromUserQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">from: </span><span class="n">from</span><span class="p">)</span>

    <span class="n">inbox_messages_from_user</span> <span class="o">=</span> <span class="n">inbox_messages</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">messages_from_user</span><span class="p">.</span><span class="nf">results</span><span class="p">)</span>
    <span class="n">unread_messages</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">inbox_messages_from_user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># other private methods...</span>
<span class="k">end</span>
</code></pre></div> <p>Now, following this approach, you could find yourself chaining a few queries from time to time, which might become a bit verbose. Let&rsquo;s attempt to make it shorter by expressing the chain of queries as a collection of queries, over which you get the results from one item of the collection and plug it into the next one:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="c1"># initialize...</span>

  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">queries</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">new_scope</span><span class="p">,</span> <span class="n">query</span><span class="o">|</span>
      <span class="n">query</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">new_scope</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># other private methods...</span>

  <span class="k">def</span> <span class="nf">queries</span>
    <span class="p">[</span>
      <span class="no">UnreadMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
      <span class="no">InboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
      <span class="no">MessagesFromUserQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">from: </span><span class="n">from</span><span class="p">)</span>
    <span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Figuring out how to write this <code>inject</code> every time would be quite the challenge. Let&rsquo;s wrap that concept in a new <code>QueryChain</code> class that does the magic for us:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">QueryChain</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">queries</span><span class="p">)</span>
    <span class="vi">@queries</span> <span class="o">=</span> <span class="n">queries</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">queries</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">new_scope</span><span class="p">,</span> <span class="n">query</span><span class="o">|</span>
      <span class="n">query</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">new_scope</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="nb">attr_reader</span> <span class="ss">:queries</span>
<span class="k">end</span>
</code></pre></div> <p>And now, you can use the <code>QueryChain</code> to define other queries like this:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UnreadInboxMessagesQuery</span>
  <span class="c1"># initialize...</span>

  <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
    <span class="n">queries</span><span class="p">.</span><span class="nf">results</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># other private methods...</span>

  <span class="k">def</span> <span class="nf">queries</span>
    <span class="no">QueryChain</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">UnreadMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
      <span class="no">InboxMessagesQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
      <span class="no">MessagesFromUserQuery</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">from: </span><span class="n">from</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>That&rsquo;s it for now. Enjoy!</p> <hr> <p><strong>Notes</strong></p> <ul> <li>The initial version of this blog post was published on 2016-01-26 and used the return value from one query&rsquo;s <code>#results</code> as the parameter of another query, and then jumped into using a <code>QueryChain</code> as the solution. The current version, updated on 2016-04-10, has a more detailed reasoning for the resulting <code>QueryChain</code> class. Thanks to Ashraf Hanafy for the feedback.</li> </ul> <section id=disqus_thread class=comments-section></section> <script>
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//gonzedge.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> </div> <aside class="col-sm-3 visible-xs-block"> <div class=sidebar-module> <h4> Recent <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020/07/26/using-certbot-to-add-lets-encrypt-certificate-on-heroku.html">Using certbot to add Let's Encrypt certificate on Heroku</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2017/01/23/rambling-trie-1-0-0-released.html">Rambling Trie 1.0.0 released!</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4>Tags</h4> <ol class="list-inline tags"> <li> <h5> <a href="/blog/tags/ruby.html">ruby (35)</a> </h5> </li> <li> <h5> <a href="/blog/tags/instructions.html">instructions (34)</a> </h5> </li> <li> <h5> <a href="/blog/tags/plugins-and-libraries.html">plugins and libraries (24)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rails.html">rails (24)</a> </h5> </li> <li> <h5> <a href="/blog/tags/releases.html">releases (18)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-slider.html">rambling-slider (17)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jquery.html">jquery (16)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rails-3-1.html">rails 3.1 (16)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rubygems.html">rubygems (15)</a> </h5> </li> <li> <h5> <a href="/blog/tags/slider.html">slider (14)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nivo-slider.html">nivo slider (14)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling.html">rambling (12)</a> </h5> </li> <li> <h5> <a href="/blog/tags/fixes.html">fixes (11)</a> </h5> </li> <li> <h5> <a href="/blog/tags/new-site.html">new site (8)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-trie.html">rambling-trie (8)</a> </h5> </li> <li> <h5> <a href="/blog/tags/performance.html">performance (7)</a> </h5> </li> <li> <h5> <a href="/blog/tags/data-structure.html">data structure (7)</a> </h5> </li> <li> <h5> <a href="/blog/tags/testing.html">testing (6)</a> </h5> </li> <li> <h5> <a href="/blog/tags/vim.html">vim (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/bugs.html">bugs (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/opinions.html">opinions (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/javascript.html">javascript (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/refactoring.html">refactoring (5)</a> </h5> </li> <li> <h5> <a href="/blog/tags/git.html">git (4)</a> </h5> </li> <li> <h5> <a href="/blog/tags/coffeescript.html">coffeescript (4)</a> </h5> </li> <li> <h5> <a href="/blog/tags/flash.html">flash (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/heroku.html">heroku (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rambling-slider-rails.html">rambling-slider-rails (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/capybara.html">capybara (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rvm.html">rvm (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/design-patterns.html">design-patterns (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/new-look.html">new look (3)</a> </h5> </li> <li> <h5> <a href="/blog/tags/rubymine.html">rubymine (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/markdown.html">markdown (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/error-handling.html">error handling (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/database-migrations.html">database migrations (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/ssh.html">ssh (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/ubuntu.html">ubuntu (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/cyanogenmod.html">cyanogenmod (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nodejs.html">nodejs (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/haml.html">haml (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jasmine.html">jasmine (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/android.html">android (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/selenium.html">selenium (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/nokogiri.html">nokogiri (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/refinerycms.html">refinerycms (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/internet-explorer.html">internet explorer (2)</a> </h5> </li> <li> <h5> <a href="/blog/tags/mercurial.html">mercurial (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/jetbrains.html">jetbrains (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/windows.html">windows (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/actionmailer.html">actionmailer (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/postgresql.html">postgresql (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/i18n.html">i18n (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/capybara-webkit.html">capybara-webkit (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/will-paginate.html">will_paginate (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/deployment.html">deployment (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/activerecord.html">activerecord (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/background-tasks.html">background tasks (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/cron.html">cron (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/simple-navigation.html">simple-navigation (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/html.html">html (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/erb.html">erb (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/assets.html">assets (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/bash.html">bash (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/github.html">github (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/pygments.html">pygments (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/lua.html">lua (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/homebrew.html">homebrew (1)</a> </h5> </li> <li> <h5> <a href="/blog/tags/powershell.html">powershell (1)</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4>By Year</h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020.html">2020 (1)</a> </h5> </li> <li> <h5> <a href="/blog/2018.html">2018 (3)</a> </h5> </li> <li> <h5> <a href="/blog/2017.html">2017 (1)</a> </h5> </li> <li> <h5> <a href="/blog/2016.html">2016 (6)</a> </h5> </li> <li> <h5> <a href="/blog/2012.html">2012 (19)</a> </h5> </li> <li> <h5> <a href="/blog/2011.html">2011 (42)</a> </h5> </li> </ol> </div> </aside> </div> </div> <footer class=footer> <div class=container> <div class=row> <p class="col-sm-12 text-center"> <a href="#">Back to top</a> </p> </div> </div> <nav class="navbar navbar-default footer-navbar"> <ul class="nav navbar-nav"> <li> <a href="https://github.com/gonzedge" class=social-link> <i class="fa fa-github"></i> </a> </li> </ul> </nav> </div> </footer> </body> </html>