<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <title> Ruby performance: Using benchmarks and memory_profiler to chase performance degradations - gonzedge.com </title> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml"/> <link href="/stylesheets/all-f8ab0163.css" rel=stylesheet /> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72477714-1', 'auto');
  ga('send', 'pageview');

</script> </head> <body> <nav class="navbar navbar-default" role=nav> <div class=container> <div class=row> <div class="col-sm-3 col-xs-6"> <header class=navbar-header> <h1 class=navbar-title> <a href="/" class=navbar-brand> <code>@gonzedge</code> </a> </h1> </header> </div> <div class="col-sm-7 hidden-xs"> <p class="navbar-text hidden-xs hidden-sm"> <code>Adventures of a software development generalist</code> </p> </div> <div class="col-sm-2 col-xs-6"> <div class=navbar-right> <ul class="nav navbar-nav"> <li> <a href="https://github.com/gonzedge" class=social-link> <i class="fa fa-github"></i> </a> </li> <li> <a href="https://www.linkedin.com/in/gonzedge" class=social-link> <i class="fa fa-linkedin"></i> </a> </li> </ul> </div> </div> </div> </div> </nav> <div class=container> <div class=row> <aside class="col-sm-3 hidden-xs"> <div class=sidebar-module> <h4> Featured <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2012/04/27/git-removing-sensitive-data-and-rewriting-history.html">Git: Removing sensitive data and rewriting history</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/11/installing-macvim-with-lua-enabled-through-homebrew.html">Installing MacVim with Lua enabled through Homebrew</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4> Recent <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020/07/26/using-certbot-to-add-lets-encrypt-certificate-on-heroku.html">Using certbot to add Let's Encrypt certificate on Heroku</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2017/01/23/rambling-trie-1-0-0-released.html">Rambling Trie 1.0.0 released!</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4>Tags</h4> <ol class="list-inline tags"> <li> <h6> <a href="/blog/tags/ruby.html">ruby (35)</a> </h6> </li> <li> <h6> <a href="/blog/tags/instructions.html">instructions (34)</a> </h6> </li> <li> <h6> <a href="/blog/tags/plugins-and-libraries.html">plugins and libraries (24)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rails.html">rails (24)</a> </h6> </li> <li> <h6> <a href="/blog/tags/releases.html">releases (18)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-slider.html">rambling-slider (17)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jquery.html">jquery (16)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rails-3-1.html">rails 3.1 (16)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rubygems.html">rubygems (15)</a> </h6> </li> <li> <h6> <a href="/blog/tags/slider.html">slider (14)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nivo-slider.html">nivo slider (14)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling.html">rambling (12)</a> </h6> </li> <li> <h6> <a href="/blog/tags/fixes.html">fixes (11)</a> </h6> </li> <li> <h6> <a href="/blog/tags/new-site.html">new site (8)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-trie.html">rambling-trie (8)</a> </h6> </li> <li> <h6> <a href="/blog/tags/performance.html">performance (7)</a> </h6> </li> <li> <h6> <a href="/blog/tags/data-structure.html">data structure (7)</a> </h6> </li> <li> <h6> <a href="/blog/tags/testing.html">testing (6)</a> </h6> </li> <li> <h6> <a href="/blog/tags/vim.html">vim (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/bugs.html">bugs (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/opinions.html">opinions (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/javascript.html">javascript (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/refactoring.html">refactoring (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/git.html">git (4)</a> </h6> </li> <li> <h6> <a href="/blog/tags/coffeescript.html">coffeescript (4)</a> </h6> </li> <li> <h6> <a href="/blog/tags/flash.html">flash (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/heroku.html">heroku (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-slider-rails.html">rambling-slider-rails (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/capybara.html">capybara (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rvm.html">rvm (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/design-patterns.html">design-patterns (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/new-look.html">new look (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rubymine.html">rubymine (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/markdown.html">markdown (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/error-handling.html">error handling (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/database-migrations.html">database migrations (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/ssh.html">ssh (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/ubuntu.html">ubuntu (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/cyanogenmod.html">cyanogenmod (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nodejs.html">nodejs (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/haml.html">haml (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jasmine.html">jasmine (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/android.html">android (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/selenium.html">selenium (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nokogiri.html">nokogiri (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/refinerycms.html">refinerycms (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/internet-explorer.html">internet explorer (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/mercurial.html">mercurial (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jetbrains.html">jetbrains (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/windows.html">windows (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/actionmailer.html">actionmailer (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/postgresql.html">postgresql (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/i18n.html">i18n (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/capybara-webkit.html">capybara-webkit (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/will-paginate.html">will_paginate (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/deployment.html">deployment (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/activerecord.html">activerecord (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/background-tasks.html">background tasks (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/cron.html">cron (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/simple-navigation.html">simple-navigation (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/html.html">html (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/erb.html">erb (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/assets.html">assets (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/bash.html">bash (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/github.html">github (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/pygments.html">pygments (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/lua.html">lua (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/homebrew.html">homebrew (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/powershell.html">powershell (1)</a> </h6> </li> </ol> </div> </aside> <div id=main class=col-sm-9 role=main> <h1> Ruby performance: Using benchmarks and memory_profiler to chase performance degradations </h1> <p> <small>February 11, 2018</small> </p> <p>While working on some of the performance improvements for <a href="https://rubygems.org/gems/rambling-trie/versions/1.0.0">version 1.0.0 of Rambling Trie</a> late in 2016 and early in 2017, I upgraded from Ruby 2.3.3 to Ruby 2.4.0 imagining that the newer version would help me on my mission to make all operations execute a bit faster. To my surprise, I ran into a significant performance degradation after upgrading - specifically, there was a ~25% increase in the time it took to execute a script using a trie with a big-ish word dictionary. This intrigued me enough that I decided to take a closer look.</p> <h3>Benchmarking with Ruby</h3> <p>After some investigation with the help of <a href="https://ruby-doc.org/stdlib-2.4.0/libdoc/benchmark/rdoc/Benchmark.html">Ruby&rsquo;s own <code>Benchmark</code></a>, I realized that while most operations were a bit slower, the main problem was a lot more visible during intensive operations like creating a brand new trie or compressing an existing one. You can see how a performance benchmark of <code>Rambling::Trie.create</code> went from <a href="https://github.com/gonzedge/rambling-trie/blob/master/reports/0.9.2/benchmark#L6">8.97 seconds with Ruby 2.3.3</a>, to <a href="https://github.com/gonzedge/rambling-trie/blob/master/reports/0.9.3/benchmark#L7">11.19 seconds with Ruby 2.4.0</a>.</p> <h3>Bringing out the big guns</h3> <p>So, I pulled in the <a href="https://rubygems.org/gems/memory_profiler">memory_profiler gem</a> to do some memory allocation monitoring:</p> <div class=highlight><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'memory_profiler'</span>

<span class="c1"># Profile trie creation</span>
<span class="n">result</span> <span class="o">=</span> <span class="no">MemoryProfiler</span><span class="p">.</span><span class="nf">report</span> <span class="ss">allow_files: </span><span class="s1">'lib/rambling/trie'</span><span class="p">,</span> <span class="ss">ignore_files: </span><span class="s1">'lib/rambling/trie/tasks'</span> <span class="k">do</span>
  <span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="no">Rambling</span><span class="o">::</span><span class="no">Trie</span><span class="p">.</span><span class="nf">create</span> <span class="s1">'/path/to/dictionary'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">result</span><span class="p">.</span><span class="nf">pretty_print</span> <span class="ss">to_file: </span><span class="s1">'reports/#{version}/#{date}/creation'</span>

<span class="c1"># Profile trie compression</span>
<span class="n">tries</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="n">tries</span> <span class="o">&lt;&lt;</span> <span class="no">Rambling</span><span class="o">::</span><span class="no">Trie</span><span class="p">.</span><span class="nf">create</span> <span class="s1">'/path/to/dictionary'</span>
<span class="k">end</span>

<span class="n">result</span> <span class="o">=</span> <span class="no">MemoryProfiler</span><span class="p">.</span><span class="nf">report</span> <span class="ss">allow_files: </span><span class="s1">'lib/rambling/trie'</span><span class="p">,</span> <span class="ss">ignore_files: </span><span class="s1">'lib/rambling/trie/tasks'</span> <span class="k">do</span>
  <span class="n">tries</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="p">.</span><span class="nf">compress!</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">result</span><span class="p">.</span><span class="nf">pretty_print</span> <span class="ss">to_file: </span><span class="s1">'reports/#{version}/#{date}/compression'</span>

<span class="c1"># ... etc.</span>
</code></pre></div> <p>The report output gives you the amount of memory (allocated and retained) and the number of objects (allocated and retained) all broken down by gem, by file, by location, and by class. It also gives you which strings were allocated and retained and how many times it happened.</p> <p>The results were really illuminating. After running a profile for all operations, three things were immediately apparent:</p> <ol> <li>The memory footprint in 2.4.0 is a bit better due to some sweet <code>Hash</code> optimizations that came with Ruby 2.4.0 (<em>#win!</em>)</li> <li>Both the creation and compression operations create a lot of new object instances, as opposed to the rest of the operations that just run through a code path with existing instances</li> <li>The rest of the memory footprint looked exactly the same, so the issue had to be elsewhere</li> </ol> <h3>Forwardable is the culprit</h3> <p>After further investigation with benchmarks and tweaking classes and methods, I realized that forwardable was the culprit. Code like this was causing issues:</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">Rambling</span>
  <span class="k">module</span> <span class="nn">Trie</span>
    <span class="c1"># A representation of a node in the Trie data structure.</span>
    <span class="k">class</span> <span class="nc">Node</span>
      <span class="c1"># ...</span>

      <span class="kp">extend</span> <span class="o">::</span><span class="no">Forwardable</span>

      <span class="n">delegate</span> <span class="p">[</span>
        <span class="ss">:[]</span><span class="p">,</span>
        <span class="ss">:[]=</span><span class="p">,</span>
        <span class="ss">:delete</span><span class="p">,</span>
        <span class="ss">:has_key?</span>
      <span class="p">]</span> <span class="o">=&gt;</span> <span class="ss">:children_tree</span>

      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Specifically, the <a href="https://github.com/evanphx/benchmark-ips">benchmark-ips gem</a> helped me analyze this issue further. I ran this benchmark:</p> <div class=highlight><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'benchmark/ips'</span>
<span class="nb">require</span> <span class="s1">'forwardable'</span>

<span class="k">class</span> <span class="nc">TestDelegate</span>
  <span class="kp">extend</span> <span class="o">::</span><span class="no">Forwardable</span>
  <span class="n">delegate</span> <span class="p">[</span><span class="ss">:[]</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="ss">:hash</span>

  <span class="nb">attr_reader</span> <span class="ss">:hash</span>

  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">hash</span>
    <span class="vi">@hash</span> <span class="o">=</span> <span class="nb">hash</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TestDirect</span>
  <span class="nb">attr_reader</span> <span class="ss">:hash</span>

  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">hash</span>
    <span class="vi">@hash</span> <span class="o">=</span> <span class="nb">hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">[]</span> <span class="n">key</span>
    <span class="nb">hash</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">bm</span><span class="o">|</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">h: </span><span class="s1">'hello'</span> <span class="p">}</span>

  <span class="n">delegate</span> <span class="o">=</span> <span class="no">TestDelegate</span><span class="p">.</span><span class="nf">new</span> <span class="nb">hash</span>
  <span class="n">bm</span><span class="p">.</span><span class="nf">report</span> <span class="s1">'delegate access'</span> <span class="k">do</span>
    <span class="n">delegate</span><span class="p">[</span><span class="ss">:h</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">direct</span> <span class="o">=</span> <span class="no">TestDirect</span><span class="p">.</span><span class="nf">new</span> <span class="nb">hash</span>
  <span class="n">bm</span><span class="p">.</span><span class="nf">report</span> <span class="s1">'direct access'</span> <span class="k">do</span>
    <span class="n">direct</span><span class="p">[</span><span class="ss">:h</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">bm</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div> <p>&hellip; and got these results:</p> <div class=highlight><pre class="highlight plaintext"><code>...
Comparison:
       direct access:  6531016.6 i/s
     delegate access:   810084.8 i/s - 8.06x  slower
</code></pre></div> <p>So&hellip; access via a delegated method in Ruby 2.4.0 is about <strong><em>8 TIMES SLOWER (!!!)</em></strong> than directly accessing the underlying field 😨. That needed to be addressed, but what do I do in the meantime? Define all those methods by hand?! <em>NO WAY</em>&hellip;</p> <h3>Creating an interim solution</h3> <p>I reached out to <a href="https://github.com/yuki24">Yuki Nishijima</a> and explained the issue. He promptly responded saying he was going to take a look. In the meantime though, I wanted to release a new version of the gem with all the performance improvements I had been working on but without the degradation from 2.4.0, so I set out to create my own version of <code>Forwardable</code> that preserved 2.3.3&rsquo;s speed and memory in 2.4.0. Here&rsquo;s what I ended up with (<em>ahem</em>, after several iterations):</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># rambling/trie/forwardable</span>
<span class="k">module</span> <span class="nn">Rambling</span>
  <span class="k">module</span> <span class="nn">Trie</span>
    <span class="k">module</span> <span class="nn">Forwardable</span>
      <span class="k">def</span> <span class="nf">delegate</span> <span class="n">methods_to_target</span>
        <span class="n">methods_to_target</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">methods</span><span class="p">,</span> <span class="n">target</span><span class="o">|</span>
          <span class="nb">methods</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
            <span class="n">define_method</span> <span class="nb">method</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
              <span class="nb">send</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="nf">send</span> <span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Then, by including these lines in the benchmark-ips script:</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># other requires</span>
<span class="nb">require</span> <span class="s1">'rambling/trie/forwardable'</span>

<span class="c1"># other test classes</span>

<span class="k">class</span> <span class="nc">TestCustomForwardable</span>
  <span class="kp">extend</span> <span class="no">Rambling</span><span class="o">::</span><span class="no">Trie</span><span class="o">::</span><span class="no">Forwardable</span>
  <span class="n">delegate</span> <span class="p">[</span><span class="ss">:[]</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="ss">:hash</span>

  <span class="nb">attr_reader</span> <span class="ss">:hash</span>

  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">hash</span>
    <span class="vi">@hash</span> <span class="o">=</span> <span class="nb">hash</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">bm</span><span class="o">|</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">h: </span><span class="s1">'hello'</span> <span class="p">}</span>

  <span class="c1"># other bm.report calls</span>

  <span class="n">custom</span> <span class="o">=</span> <span class="no">TestCustomForwardable</span><span class="p">.</span><span class="nf">new</span> <span class="nb">hash</span>
  <span class="n">bm</span><span class="p">.</span><span class="nf">report</span> <span class="s1">'custom delegate access'</span> <span class="k">do</span>
    <span class="n">custom</span><span class="p">[</span><span class="ss">:h</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">bm</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div> <p>&hellip; I got these results (the <code>custom delegate access</code> is the benchmark with <code>Rambling::Trie::Forwardable</code>):</p> <div class=highlight><pre class="highlight plaintext"><code>...
Comparison:
       direct access:  6642032.3 i/s
custom delegate access:  2301340.9 i/s - 2.89x  slower
     delegate access:   835004.6 i/s - 7.95x  slower
</code></pre></div> <p>And <a href="https://github.com/gonzedge/rambling-trie/blob/master/reports/0.9.3/benchmark#L64">BAM! - back to (basically) the same numbers</a>, which then pretty much <a href="https://github.com/gonzedge/rambling-trie/blob/master/reports/1.0.0/benchmark">transferred nicely to 1.0.0</a>.</p> <h3>Contributing back to the community</h3> <p>I submitted <a href="https://bugs.ruby-lang.org/issues/13111">an issue</a> to Ruby&rsquo;s Redmine and soon after got an answer back from Yuki: he pointed out that an <code>UnboundMethod</code> instance was being created <a href="https://github.com/ruby/ruby/blob/2283d14cc9fefa278dfde02bdf8d84ce50cfe16f/lib/forwardable.rb#L207">on every delegated call</a>. We also noticed that <a href="https://github.com/nobu">Nobuyoshi Nakada</a> had fixed the issue on trunk revisions <a href="https://bugs.ruby-lang.org/projects/ruby-trunk/repository/trunk/revisions/57255">#57255</a>, <a href="https://bugs.ruby-lang.org/projects/ruby-trunk/repository/trunk/revisions/57255">#57256</a> &amp; <a href="https://bugs.ruby-lang.org/projects/ruby-trunk/repository/trunk/revisions/57255">#57257</a>.</p> <p>Finally, these revisions were included into the <code>ruby_2_4</code> branch in revision <a href="https://bugs.ruby-lang.org/projects/ruby-trunk/repository/ruby_2_4/revisions/57913">#57913</a> in February 2017. Ruby 2.4.1 came out soon after and running the same benchmark in 2.4.1 gave me these results:</p> <div class=highlight><pre class="highlight plaintext"><code>...
Comparison:
       direct access:  6272727.2 i/s
     delegate access:  2823600.3 i/s - 2.22x  slower
custom delegate access:  2288089.7 i/s - 2.74x  slower
</code></pre></div> <p>&hellip; which means I could go back to using Ruby&rsquo;s own <code>Forwardable</code> again! By May 2017 I was able to <a href="https://github.com/gonzedge/rambling-trie/commit/b98b0bf103cf113ad137ab7e27af90e8cadf6668">do so</a> and <a href="https://github.com/gonzedge/rambling-trie/commit/0ade8df3225759f7237184acb1c7281f298228d2">delete my own implementation</a>. This is one of my favorite parts about writing code: deleting code.</p> <hr> <p><strong>Update on 2018-02-15</strong></p> <p>Ruby 2.5.0&rsquo;s <code>Forwardable</code> performs a bit slower now, but it&rsquo;s still faster than my own implementation:</p> <div class=highlight><pre class="highlight plaintext"><code>...
Comparison:
       direct access:  6231242.7 i/s
     delegate access:  2582759.7 i/s - 2.41x  slower
custom delegate access:  2107914.3 i/s - 2.96x  slower
</code></pre></div> <p>🤔&hellip; Looking at this more closely, maybe I should drop the <code>Forwardable</code> module and just define the methods directly to avoid this 2x slower business. I guess that&rsquo;ll be a topic for a future blog post.</p> <hr> <p><strong>Notes</strong></p> <ul> <li>You can see the <a href="https://github.com/gonzedge/rambling-trie/blob/v1.0.0/lib/rambling/trie/forwardable.rb">full documented version of <code>Rambling::Trie::Forwardable</code> on GitHub</a>.</li> <li>The Redmine issue has been addressed and the fix was backported to Ruby 2.2.</li> </ul> <section id=disqus_thread class=comments-section></section> <script>
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//gonzedge.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> </div> <aside class="col-sm-3 visible-xs-block"> <div class=sidebar-module> <h4> Recent <span class="pull-right see-more"> <a href="/blog/" class=button>See all posts →</a> </span> </h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020/07/26/using-certbot-to-add-lets-encrypt-certificate-on-heroku.html">Using certbot to add Let's Encrypt certificate on Heroku</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/19/ruby-performance-attr-accessor-vs-def-method.html">Ruby performance: #attr_accessor vs. method definition</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/15/ruby-performance-hash-has-key-vs-square-brackets.html">Ruby performance: Hash's #has_key? vs. #[] (square brackets)</a> </h5> </li> <li> <h5> <a href="/blog/2018/02/11/ruby-performance-using-benchmarks-and-memory-profiler-to-chase-performance-degradations.html">Ruby performance: Using benchmarks and memory_profiler to chase performance degradations</a> </h5> </li> <li> <h5> <a href="/blog/2017/01/23/rambling-trie-1-0-0-released.html">Rambling Trie 1.0.0 released!</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/page-objects-where-do-you-put-your-assertions.html">Page Objects: Where do you put your assertions?</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/12/specifying-failure-message-for-rspec-expectations.html">Specifying failure message for RSpec expectations</a> </h5> </li> <li> <h5> <a href="/blog/2016/04/10/using-page-objects-in-your-acceptance-tests.html">Using Page Objects in your Acceptance Tests</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/27/unit-testing-active-record-eager-loading.html">Unit Testing ActiveRecord eager-loading</a> </h5> </li> <li> <h5> <a href="/blog/2016/01/26/query-objects-in-the-rails-world-a-different-approach.html">Query Objects in the Rails world - A Different Approach</a> </h5> </li> </ol> </div> <div class=sidebar-module> <h4>Tags</h4> <ol class="list-inline tags"> <li> <h6> <a href="/blog/tags/ruby.html">ruby (35)</a> </h6> </li> <li> <h6> <a href="/blog/tags/instructions.html">instructions (34)</a> </h6> </li> <li> <h6> <a href="/blog/tags/plugins-and-libraries.html">plugins and libraries (24)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rails.html">rails (24)</a> </h6> </li> <li> <h6> <a href="/blog/tags/releases.html">releases (18)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-slider.html">rambling-slider (17)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jquery.html">jquery (16)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rails-3-1.html">rails 3.1 (16)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rubygems.html">rubygems (15)</a> </h6> </li> <li> <h6> <a href="/blog/tags/slider.html">slider (14)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nivo-slider.html">nivo slider (14)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling.html">rambling (12)</a> </h6> </li> <li> <h6> <a href="/blog/tags/fixes.html">fixes (11)</a> </h6> </li> <li> <h6> <a href="/blog/tags/new-site.html">new site (8)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-trie.html">rambling-trie (8)</a> </h6> </li> <li> <h6> <a href="/blog/tags/performance.html">performance (7)</a> </h6> </li> <li> <h6> <a href="/blog/tags/data-structure.html">data structure (7)</a> </h6> </li> <li> <h6> <a href="/blog/tags/testing.html">testing (6)</a> </h6> </li> <li> <h6> <a href="/blog/tags/vim.html">vim (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/bugs.html">bugs (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/opinions.html">opinions (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/javascript.html">javascript (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/refactoring.html">refactoring (5)</a> </h6> </li> <li> <h6> <a href="/blog/tags/git.html">git (4)</a> </h6> </li> <li> <h6> <a href="/blog/tags/coffeescript.html">coffeescript (4)</a> </h6> </li> <li> <h6> <a href="/blog/tags/flash.html">flash (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/heroku.html">heroku (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rambling-slider-rails.html">rambling-slider-rails (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/capybara.html">capybara (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rvm.html">rvm (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/design-patterns.html">design-patterns (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/new-look.html">new look (3)</a> </h6> </li> <li> <h6> <a href="/blog/tags/rubymine.html">rubymine (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/markdown.html">markdown (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/error-handling.html">error handling (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/database-migrations.html">database migrations (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/ssh.html">ssh (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/ubuntu.html">ubuntu (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/cyanogenmod.html">cyanogenmod (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nodejs.html">nodejs (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/haml.html">haml (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jasmine.html">jasmine (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/android.html">android (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/selenium.html">selenium (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/nokogiri.html">nokogiri (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/refinerycms.html">refinerycms (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/internet-explorer.html">internet explorer (2)</a> </h6> </li> <li> <h6> <a href="/blog/tags/mercurial.html">mercurial (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/jetbrains.html">jetbrains (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/windows.html">windows (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/actionmailer.html">actionmailer (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/postgresql.html">postgresql (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/i18n.html">i18n (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/capybara-webkit.html">capybara-webkit (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/will-paginate.html">will_paginate (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/deployment.html">deployment (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/activerecord.html">activerecord (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/background-tasks.html">background tasks (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/cron.html">cron (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/simple-navigation.html">simple-navigation (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/html.html">html (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/erb.html">erb (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/assets.html">assets (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/bash.html">bash (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/github.html">github (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/pygments.html">pygments (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/lua.html">lua (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/homebrew.html">homebrew (1)</a> </h6> </li> <li> <h6> <a href="/blog/tags/powershell.html">powershell (1)</a> </h6> </li> </ol> </div> <div class=sidebar-module> <h4>By Year</h4> <ol class=list-unstyled> <li> <h5> <a href="/blog/2020.html">2020 (1)</a> </h5> </li> <li> <h5> <a href="/blog/2018.html">2018 (3)</a> </h5> </li> <li> <h5> <a href="/blog/2017.html">2017 (1)</a> </h5> </li> <li> <h5> <a href="/blog/2016.html">2016 (6)</a> </h5> </li> <li> <h5> <a href="/blog/2012.html">2012 (19)</a> </h5> </li> <li> <h5> <a href="/blog/2011.html">2011 (42)</a> </h5> </li> </ol> </div> </aside> </div> </div> <footer class=footer> <div class=container> <div class=row> <p class="col-sm-12 text-center"> <a href="#">Back to top</a> </p> </div> </div> <nav class="navbar navbar-default footer-navbar"> <ul class="nav navbar-nav"> <li> <a href="https://github.com/gonzedge" class=social-link> <i class="fa fa-github"></i> </a> </li> <li> <a href="https://www.linkedin.com/in/gonzedge" class=social-link> <i class="fa fa-linkedin"></i> </a> </li> </ul> </nav> </div> </footer> </body> </html>